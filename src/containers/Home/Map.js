import { useEffect, useRef } from "react";

const lineData = {
  '1-6': [[121.13966578465437,31.293190667283028],[121.14541161303515,31.285825486786663],[121.15058285857862,31.281897155254995],[121.1551795212846,31.27796866007442],[121.15747785263869,31.275513267489586],[121.15977618399052,31.272566712014964],[121.16322368101947,31.269128947637967],[121.166096595211,31.26569105799635],[121.17011867507955,31.263235345850262],[121.17471533778553,31.259797241487405],[121.179886583329,31.257832554190557],[121.18505782887235,31.255867825999346],[121.1885053259013,31.254394253020138],[121.19769865131326,31.252429453267283],[121.2045936453734,31.250464612624114],[121.20861572523972,31.24800850432007],[121.21493613646021,31.243096096057755],[121.21895821632876,31.24014852844884],[121.22298029619509,31.237200868856277],[121.22642779322399,31.23376181641636],[121.2304498730926,31.230813957545706],[121.23504653579863,31.227866006707004],[121.23964319850461,31.223935262538888],[121.2471127753999,31.21558188840052],[121.25056027243102,31.213124873183332],[121.2580298493263,31.207227776176325],[121.26147734635742,31.204770543895236]],

  '2-6': [[121.23255812157998,31.349645034553475],[121.23805128564277,31.342021512551668],[121.24079786767413,31.338502755558025],[121.24697767724507,31.33205135929424],[121.2517841957997,31.326772615217592],[121.25384413232285,31.32090699683134],[121.25659071435422,31.316800846530157],[121.25659071435422,31.311521247343236],[121.25659071435422,31.305068001995025],[121.2552174233378,31.299201031725843],[121.25384413232285,31.292160185233783],[121.25247084130649,31.287465995379108],[121.24972425927507,31.281011102694094],[121.2456043862287,31.26516540201868],[121.2456043862287,31.261056822950124],[121.2442310952137,31.254600123039026],[121.24697767724507,31.24638186624901],[121.2456043862287,31.238162894191277],[121.25041090478328,31.230530351202376],[121.25315748681464,31.22348437966184],[121.25590406884601,31.21878677347233],[121.25865065087737,31.212327183802785],[121.26208387841695,31.202930629258574],[121.29023634423623,31.15475863927368],[121.29023634423623,31.15475863927368],[121.29022121429443,31.15475576817255],[121.29022121429443,31.15475576817255],[121.29022121429443,31.15475576817255],[121.29742022445868,31.1527737230536]],
  '3-6': [[121.35953657725094,31.33231976174052],[121.36089668575744,31.328059886177314],[121.36225679426383,31.324187104733255],[121.36271016376548,31.3226379475459],[121.36407027227364,31.319926861132856],[121.36407027227364,31.318377633849238],[121.36497701127684,31.314504454131438],[121.36452364177524,31.309856428207695],[121.36407027227364,31.30675761683605],[121.36316353326873,31.303271332204076],[121.36180342476229,31.295910974364432],[121.35953657725094,31.289712332423534],[121.35862983824597,31.28196345681664],[121.35953657725094,31.27343895816547],[121.36044331625578,31.26956393136892],[121.36044331625578,31.262200941979415],[121.36044331625578,31.259100564045568],[121.36044331625578,31.256387649810023],[121.35862983824597,31.251736758294243],[121.35681636023793,31.24902363243484],[121.35273603471677,31.245535213205855],[121.34956244820216,31.242434287932156],[121.34774897019236,31.237007423718595],[121.34684223118927,31.230029568766696],[121.34684223118927,31.22615276001366],[121.34638886168591,31.222663496160976],[121.34593549218437,31.21878638525044],[121.34684223118927,31.214521379589158],[121.34865570919732,31.208317391552853],[121.34865570919732,31.20056183417219],[121.34729560069087,31.192417814598613],[121.34366864467296,31.186988078813812],[121.33958831915345,31.1827216393215],[121.33233440711774,31.179230773081457],[121.32508049508203,31.175739778134073],[121.31465299653178,31.16992116722541],[121.30694571499447,31.166041894693734],[121.2996918029587,31.161386557962018],[121.29742022445868,31.1527737230536]],
  '5-6': [[121.1405591972383,31.134613813155156],[121.14917321778051,31.134613813155156],[121.15778723832278,31.135001876198345],[121.16368104185199,31.135001876198345],[121.16957484537954,31.135001876198345],[121.17818886592181,31.135001876198345],[121.18453603895256,31.135001876198345],[121.18816299497047,31.135001876198345],[121.19360342899813,31.1361660558008],[121.19677701551268,31.137330221113686],[121.2022174495404,31.140046551271453],[121.2062977750598,31.14159870500073],[121.2153651651036,31.143150833323688],[121.22307244664091,31.143538861434806],[121.23168646718318,31.143538861434806],[121.2412072267303,31.143538861434806],[121.24755439976116,31.143926887957946],[121.25208809478391,31.143926887957946],[121.25843526781472,31.143926887957946],[121.26523581034712,31.143926887957946],[121.27158298337798,31.144314912892426],[121.27974363441854,31.145090957998917],[121.2847306989429,31.145866996752645],[121.289264393964,31.147807065847616],[121.29742022445868,31.1527737230536]],
  '5-8': [[121.14119909609923,31.135358601246907],[121.13773301101259,31.130661068789692],[121.136288808894,31.127694086328617],[121.13426692592606,31.12522153006499],[121.13253388338268,31.12274890937023],[121.12849011744686,31.117061637266403],[121.12617939405658,31.111374024368786],[121.12531287278489,31.106675304519698],[121.12415751108864,31.074519931639557],[121.12415751108864,31.071056396345227],[121.12531287278489,31.066850505307812],[121.13340040465437,31.053736827617854],[121.13657764931867,31.047055579855027],[121.14119909609923,31.034681660321127],[121.14582054288206,31.025771442490623],[121.1513085109367,31.017355471422732],[121.15477459602329,31.01215700028193]],
  '4-5': [[121.04745775069216,31.10119898923955],[121.05227547330173,31.10119898923955],[121.05709319591142,31.101633220374367],[121.06419299765179,31.10337012506271],[121.06647507678429,31.104672782732067],[121.06926428461003,31.108146449156706],[121.0725606211326,31.1116199885045],[121.07458913591461,31.113790886062247],[121.07763190809084,31.115744651417742],[121.08194250200353,31.11921791275668],[121.08599953156966,31.122256912164374],[121.08878873939727,31.124210503250794],[121.09309933331002,31.12659817107044],[121.09715636287615,31.128551672777633],[121.10197408548578,31.130071035186475],[121.10805962983409,31.13202446538513],[121.11566656027145,31.133760814014707],[121.1214985402712,31.13484601576792],[121.12656982722939,31.135063054628304],[121.13240180723113,31.135063054628304],[121.13620527244876,31.13528009299297],[121.13772665853588,31.13528009299297]],
  '10-6': [[121.45172192980277,31.143748065122367],[121.44216668714643,31.13884109686701],[121.43484100110828,31.137205384356363],[121.42910785551453,31.13529701743768],[121.42082664521075,31.13229807755856],[121.4122269268201,31.1314801684084],[121.40649378122384,31.130662252206676],[121.39980511136446,31.13038961190547],[121.39470898194696,31.129571686301063],[121.38706478782188,31.127390516880112],[121.37400595618999,31.12384600962325],[121.36954684294875,31.123573349734386],[121.35999160029246,31.125209297315052],[121.35457696278559,31.127390516880112],[121.34852530910246,31.1298443289529],[121.34374768777434,31.13229807755856],[121.33928857453304,31.133933874701015],[121.33355542893929,31.13584226904665],[121.32559272672495,31.139386328100997],[121.32017808922052,31.14183982986269],[121.31635599215548,31.142930254713562],[121.31221538700362,31.144293268142718],[121.30711925758857,31.14647404887461],[121.30266014434733,31.148927367238528],[121.29851953919547,31.149745125917676],[121.29469744213293,31.151108041373348],[121.29742022445868,31.1527737230536]]
}

const pointJsonData = {
  "type": "FeatureCollection",
  "features": [
        {
            "geometry": {
                "type": "Point",
                "coordinates": [121.144710783,31.277730705]
            },
            "properties": {
                "time": 34.976808170970244
            }
        }, {
            "geometry": {
                "type": "Point",
                "coordinates": [121.144710783,31.277730705]
            },
            "properties": {
                "time": 90.8039890451743
            }
        }, {
            "geometry": {
                "type": "Point",
                "coordinates": [121.359637806,31.290768164]
            },
            "properties": {
                "time": 84.83746539866945
            }
        },


        {
          "geometry": {
              "type": "Point",
              "coordinates": [121.144710783,31.277730705]
          },
          "properties": {
              "time": 34.976808170970244
          }
      }, {
          "geometry": {
              "type": "Point",
              "coordinates": [121.144710783,31.277730705]
          },
          "properties": {
              "time": 90.8039890451743
          }
      }, {
          "geometry": {
              "type": "Point",
              "coordinates": [121.359637806,31.290768164]
          },
          "properties": {
              "time": 84.83746539866945
          }
      }
    ]
}

const dataListDemo = [
  {
    id: 1,
    name: '静安',
    type: "creator",
    child: [6],
    position: [121.13966578465437,31.293190667283028],
  },
  {
    id: 2,
    name: '黄渡',
    type: "creator",
    child: [6],
    position: [121.23255812157998,31.349645034553475],
  },
  {
    id: 3,
    name: '远东',
    type: "consumer",
    child: [6],
    position: [121.36163945761967,31.332088712672856],
  },
  {
    id: 4,
    name: '五角场',
    type: "creator",
    child: [5],
    position: [121.04745775069216,31.10119898923955],
  },
  {
    id: 5,
    name: '顾路',
    type: "creator",
    child: [6, 8],
    position: [121.139276547,31.136801787],
  },
  {
    id: 6,
    name: '新余',
    type: "consumer",
    child: [],
    position: [121.29742022445868,31.1527737230536],
  },
  {
    id: 7,
    name: '五角场',
    type: "creator",
    child: [6],
    position: [121.413744365,31.208347403],
  },
  {
    id: 8,
    name: '三林',
    type: "consumer",
    child: [],
    position: [121.154347399,31.013810054],
  },
  {
    id: 9,
    name: '杨高',
    type: "consumer",
    child: [6],
    position: [121.301388717,31.063346273],
  },
  {
    id: 10,
    name: '徐行',
    type: "creator",
    child: [6],
    position: [121.454887918,31.14815129],
  },
];

var data = [
  {
    type: "Feature",
    properties: {
      name: "北京市-天津市",
    },
    geometry: {
      type: "LineString",
      coordinates: [
        ["116.407394", "39.904211"],
        ["117.200983", "39.084158"],
      ],
    },
  },
  {
    type: "Feature",
    properties: {
      name: "北京市-河北省",
    },
    geometry: {
      type: "LineString",
      coordinates: [
        ["116.407394", "39.904211"],
        ["114.530235", "38.037433"],
      ],
    },
  },
];

const { LKMap, mapvgl } = window;

// 生产者颜色
const CREATOR_COLOR = "#5CDBD3";
// 消费者颜色
const CONSUMER_COLOR = "#FF85C0";

const getGradualLineLayerData = (data) => {
  const rArray = [];
  if (data && data.length) {
    const dataObj = data.reduce((total, item) => {
      total[item.id] = item;
      return total;
    }, {});
    data.forEach((val) => {
      if (val.child && val.child.length) {
        val.child.forEach((valKey) => {
          if (dataObj[valKey]) {
            // rArray.push([val.position, dataObj[valKey].position]);
            rArray.push({
              type: "Feature",
              // properties: {
              //   name: "北京市-河北省",
              // },
              geometry: {
                type: "LineString",
                coordinates: lineData[`${val.id}-${dataObj[valKey].id}`] || [val.position, dataObj[valKey].position],
              },
              parentPoint: val,
              childPoint: dataObj[valKey],
            });
          }
        });
      }
    });
  }
  return rArray;
};

const getScatterPointLayerData = (data) => {
  return {
    type: "FeatureCollection",
    features: data.map((val) => {
      return {
        ...val,
        geometry: {
          type: "Point",
          coordinates: val.position,
        },
        properties: {
          pType: val.type,
        },
      };
    }),
  };
};

const Map = () => {
  const mapRef = useRef(null);
  const gradualLineLayerRef = useRef(null);
  const scatterPointLayerRef = useRef(null);

  // 创建地图
  const createMap = () => {
    console.log('00000')
    mapRef.current = new LKMap.Map("map", {
      // 地图中心
      center: [121.248407,31.221486],
      // 地图缩放级别
      style: "lkmap://styles/3e46461651084f19a29688d4ac71e3c8",
      zoom: 9.5
    });
  };

  // 创建渐变可视化图层
  const createGradualLineView = () => {
    const gradualData = getGradualLineLayerData(dataListDemo);
    gradualLineLayerRef.current = new mapvgl.GradualLineLayer({
      map: mapRef.current, // 添加到的地图对象
      data: gradualData, // geojson线数据
    });
    return gradualData;
  };

  // 创建呼吸点图层
  const createScatterPointView = () => {
    const data = getScatterPointLayerData(dataListDemo);
    console.log("data", data);
    const view = new mapvgl.View({ map: mapRef.current });
    // 初始化完成添加 Layer
    view.on("loaded", () => {
      // 创建图层实例
      scatterPointLayerRef.current = new mapvgl.ScatterPointLayer({
        id: "scatter",
        data: data, // geojson数据
        color: {
          keyName: "pType",
          value: (v) => {
            console.log("v", v);
            return v === "creator" ? CREATOR_COLOR : CONSUMER_COLOR;
          },
        }, // 颜色
        size: 40, // 大小
      });
      view.addLayer(scatterPointLayerRef.current);
    });
  };

  // 地图加载完成之后，开始创建各种图层
  const addLayerFun = () => {
    console.log('111')
    const gradualData = createGradualLineView();
    console.log('gradualData', gradualData )
    createScatterPointView();
    if (gradualLineLayerRef.current) {
      // 渐变图层设置样式
      const lineWidth = 2;
      gradualData.forEach((val) => {
        console.log('val', val)
        gradualLineLayerRef.current.addLayer({
          id: `${val.parentPoint.id}-${val.childPoint.id}`,
          style: {
            color: {
              0:
                val.parentPoint.type === "creator"
                  ? CREATOR_COLOR
                  : CONSUMER_COLOR,
              1:
                val.childPoint.type === "creator"
                  ? CREATOR_COLOR
                  : CONSUMER_COLOR,
            },
            width: lineWidth,
          },
        });
      });
    }
  };

  useEffect(() => {
    createMap();
    if (mapRef.current) {
      mapRef.current.on("load", addLayerFun);
    }
  }, []);
  return (
    <div
      style={{
        width: "100%",
        height: "100%",
      }}
    >
      <div
        id="map"
        style={{
          width: "100%",
          height: "100%",
        }}
      ></div>
    </div>
  );
};

export default Map;
